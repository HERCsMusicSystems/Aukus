<!DOCTYPE html><meta charset="UTF-8"/>

<!--
///////////////////////////////////////////////////////////////////////////////////
//                     Copyright (C) 2023 Dr Robert P. Wolf                      //
//                                                                               //
// Permission is hereby granted, free of charge, to any person obtaining a copy  //
// of this software and associated documentation files (the "Software"), to deal //
// in the Software without restriction, including without limitation the rights  //
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell     //
// copies of the Software, and to permit persons to whom the Software is         //
// furnished to do so, subject to the following conditions:                      //
//                                                                               //
// The above copyright notice and this permission notice shall be included in    //
// all copies or substantial portions of the Software.                           //
//                                                                               //
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR    //
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,      //
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE   //
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER        //
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, //
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN     //
// THE SOFTWARE.                                                                 //
///////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////
// Program started on 13th April 2023 //
////////////////////////////////////////
-->

<html>

<head>
	<title>Aukus Game Play....</title>
	<link rel="shortcut icon" type="image/x-icon" href="h.ico"/>
	<style>
	a:link {color: blue; text-shadow: 1px 1px red;}
	a:visited {color: blue;}
	a:hover {color: red; text-shadow: 1px 1px blue;}
	a:active {color: red;}
	</style>
</head>

<body bgcolor="#0000aa" onkeydown="KeyPressed (event);" onwheel="OnWheel (event);" oncontextmenu="event . preventDefault ();" style="font-family: arial; color: gold; text-shadow: 1px 1px red; background-size: cover; margin: 0; width: 100%; height: 100%; border: 0; overflow: hidden; display: block;">
<script src="settings.js"></script>
<script src="vessel.js"></script>

<div style="margin: 0;"><canvas id="aukus" onmousedown="return OnMouseDown (event);" style="cursor: default;"/></div>

<div id="info" style="position: absolute; left: 8px; bottom: 8px; font-family: arial;">
	<table style="background: #4444ffb0; color: gold;">
		<tr>
			<td>Bearing:</td><td><div id="selected_bearing" style="text-align: right;">5</td><td><div id="simulated_bearing" style="text-align: right;">123</td>
			<td rowspan="5"><canvas id="thermocline_canvas" width="16"></td>
			<td rowspan="5"><div id="selected_image" style="text-align: center;"><img src="silhouettes/Sovremenny.png"/></td>
		</tr>
		<tr><td>Speed:</td><td><div id="selected_speed" style="text-align: right;">123</td><td><div id="simulated_speed" style="text-align: right;">123</td></tr>
		<tr><td>Depth:</td><td><div id="selected_depth" style="text-align: right;">123</td><td><div id="simulated_depth" style="text-align: right;">123</td></tr>
		<tr><td>Distance:</td><td><div id="selected_distance" style="text-align: right;">123</td><td><div id="selected_bearing" style="text-align: right;">123</td></tr>
		<tr><td>Thermoclines:</td><td colspan="2"><div id="thermoclines">1, 2, 3</td></tr>
	</table>
</div>

<div id="ctrl" style="position: absolute; top: 8px; right: 8px; font-family: arial;">
	<table style="background: #ff00ffb0; color: yellow;">
		<tr>
			<td>SPEED:</td>
			<td>
				<button onclick="simulated . setSpeed ('stop');">STOP</button>
				<button onclick="simulated . setSpeed ('slow');">SLOW</button>
				<button onclick="simulated . setSpeed ('one quarter');">1/4</button>
				<button onclick="simulated . setSpeed ('half');">HALF</button>
				<button onclick="simulated . setSpeed ('three quarters');">3/4</button>
				<button onclick="simulated . setSpeed ('full');">FULL</button>
				<button onclick="simulated . setSpeed ('flank');">FLANK</button>
				<button onclick="simulation_ratio = 1;">&#xd7;1</button>
				<button onclick="simulation_ratio = 2;">&#xd7;2</button>
				<button onclick="simulation_ratio = 4;">&#xd7;4</button>
				<button onclick="simulation_ratio = 8;">&#xd7;8</button>
				<button onclick="simulation_ratio = 16;">&#xd7;16</button>
				<button onclick="MissionAbort ();">ABORT</button>
			</td>
		</tr>
		<tr>
			<td>DEPTH:</td>
			<td>
				<button onclick="simulated . targetDepth ('surface');">SURFACE</button>
				<button onclick="simulated . targetDepth ('periscope');">PERISCOPE</button>
				<button onclick="simulated . targetDepth ('attack');">ATTACK</button>
				<button onclick="simulated . targetDepth ('up thermal');">UP THERMAL</button>
				<button onclick="simulated . targetDepth ('down thermal');">DOWN THERMAL</button>
				<button onclick="simulated . targetDepth ('test');">TEST</button>
				<button onclick="simulated . targetDepth ('crush');">CRUSH</button>
				<button onclick="PauseSimulation (); simulated . targetDepth (prompt ('Enter depth')); ResumeSimulation ();">SPECIFY</button>
			</td>
		</tr>
		<tr>
			<td>SONAR:</td>
			<td>
				<button onclick="simulated . sonar . ping ();">PING</button>
				<button id="DeployTowedArray" onclick="simulated . sonar . deployTowedArray (); document . getElementById ('CutTowedArray') . disabled = false; this . disabled = true;">DEPLOY TOWED ARRAY</button>
				<button id="RetrieveTowedArray" onclick="simulated . sonar . retrieveTowedArray (); this . disabled = true;" disabled>RETRIEVE TOWED ARRAY</button>
				<button id="CutTowedArray" onclick="simulated . sonar . cutTowedArray (); document . getElementById ('RetrieveTowedArray') . disabled = true; this . disabled = true;" disabled>CUT TOWED ARRAY</button>
			</td>
		</tr>
		<tr>
			<td>WEAPON:</td>
			<td>
				<button onclick="WeaponDetonate ();">DETONATE</button>
				<button onclick="WeaponSearchSub ();">SEARCH SUB</button>
				<button onclick="WeaponSearchSurface ();">SEARCH SURFACE</button>
				<button onclick="WeaponMatchDepth ();">MATCH DEPTH</button>
				<button onclick="WeaponPromptDepth ();">DEPTH</button>
				<button onclick="WeaponToToWaypoint ();">GO TO</button>
				<button onclick="WeaponSelectTarget ();">TARGET</button>
			</td>
		</tr>
	</table>
</div>

<script>

var canvas = document . getElementById ('aukus');
var ctx = canvas . getContext ('2d');
var scaling = 1;
var simulation_ratio = 1;
var DamageShift = 0;
var vessels = [];
var time = Date . now ();

var LosAngeles = new Image (); LosAngeles . src = 'silhouettes/LosAngelesTopView.png';
simulated = new Vessel ('Australia');
selected = null;
vessels . push (simulated);

var simulate = function (delta) {
	for (var v of vessels) {
		v . move (delta);
	}
};

var ShiftMapPosition = function (width, height, vessel) {
	var mile = 128 * scaling;
	var shift = vessel === null ? {x: 0, y: 0} : {x: vessel . position . x * mile, y: vessel . position . y * mile};
	shift . half_width = width * 0.5; shift . half_height = height * 0.5;
	ctx . translate (shift . half_width - shift . x, shift . half_height - shift . y);
	return shift;
};

var DrawGrid = function (shift) {
	var mile = 128 * scaling;
	ctx . beginPath ();
	ctx . lineWidth = 1.5;
	ctx . strokeStyle = 'gold';
	var ll = shift . x - shift . half_width;
	var lr = shift . x + shift . half_width;
	var lt = shift . y - shift . half_height;
	var lb = shift . y + shift . half_height;
	var gl = Math . floor (ll / mile) * mile + mile;
	var gr = Math . floor (lr / mile) * mile + 1;
	var gt = Math . floor (lt / mile) * mile + mile;
	var gb = Math . floor (lb / mile) * mile + 1;
	for (var ind = gl; ind < gr; ind += mile) {ctx . moveTo (ind, lt); ctx . lineTo (ind, lb);}
	for (var ind = gt; ind < gb; ind += mile) {ctx . moveTo (ll, ind); ctx . lineTo (lr, ind);}
	ctx . stroke ();
};

var DrawSimulated = function (vessel) {
	var scc = scaling * 110 * 128 / 1852;
	var p = vessel . position;
	var mile = 128 * scaling;
	var x = p . x * mile, y = p . y * mile;
	vessel . DrawTrail (ctx, mile);
	if (scc < 24) {
		var alpha = Math . cos (p . bearing) * 12, beta = Math . sin (p . bearing) * 12;
		ctx . save ();
		ctx . lineCap = 'round'; ctx . lineWidth = 4; ctx . strokeStyle = 'lime';
		ctx . beginPath (); ctx . moveTo (x - alpha, y - beta); ctx . lineTo (x + alpha, y + beta); ctx . stroke ();
		ctx . restore ();
	} else {
		scc /= LosAngeles . width;
		ctx . save ();
		ctx . scale (scc, scc); ctx . translate (x / scc, y / scc); ctx . rotate (p . bearing); ctx . translate (LosAngeles . width * -0.5, LosAngeles . height * -0.5); ctx . drawImage (LosAngeles, 0, 0);
		ctx . restore ();
	}
};

var resize = function (delta) {
	var now = Date . now ();
	if (delta === undefined) delta = (now - time) / 1000;
	time = now;
	for (var ind = 0; ind < simulation_ratio; ind ++) simulate (delta);
	var degrees = simulated . position . bearing * 180 / Math . PI + 90;
	while (degrees > 360) degrees -= 360; while (degrees < 0) degress += 360;
	document . getElementById ('simulated_bearing') . innerHTML = degrees . toFixed (0);
	document . getElementById ('simulated_speed') . innerHTML = simulated . speed . x;
	document . getElementById ('simulated_depth') . innerHTML = simulated . position . depth;
	if (selected) {
		degrees = simulated . position . bearing * 180 / Math . PI + 90;
		while (degrees > 360) degrees -= 360; while (degrees < 0) degrees += 360;
		document . getElementById ('selected_bearing') . innerHTML = degrees . toFixed (0);
	} else document . getElementById ('selected_bearing') . innerHTML = '<>'
	document . getElementById ('selected_speed') . innerHTML = selected ? selected . position . speed . x : '<>';
	document . getElementById ('selected_depth') . innerHTML = selected ? selected . position . depth : '<>';
	canvas . width = window . innerWidth; canvas . height = window . innerHeight;
	if (DamageShift > 0) {var alpha = Math . random () * Math . PI * 2; ctx . translate (Math . cos (alpha) * 20, Math . sin (alpha) * 20); DamageShift --;}
	DrawGrid (ShiftMapPosition (canvas . width, canvas . height, simulated));
	DrawSimulated (simulated);
};

var simulation_interval = setInterval (resize, 50);

var control_panel = document . getElementById ('ctrl');
var info_panel = document . getElementById ('info');
var KeyPressed = function (e) {
	var key = e . key . toLowerCase ();
	if (key === 'control' || key === 'r') return true;
	var ws = e . shiftKey ? control_panel . style : info_panel . style;
	switch (key) {
	case '0': case '1': case '2': case '3': case '4': case '5': case '6': simulated . setSpeed (Number (key)); break;
	case 'z': simulation_ratio = 1; break;
	case 'x': simulation_ratio = 2; break;
	case 'c': simulation_ratio = 4; break;
	case 'v': simulation_ratio = 8; break;
	case 'b': simulation_ratio = 16; break;
	case 'arrowright': e . preventDefault (); ws . left = null; ws . right = '8px'; break;
	case 'arrowleft': e . preventDefault (); ws . right = null; ws . left = '8px'; break;
	case 'arrowdown': e . preventDefault (); ws . top = null; ws . bottom = '8px'; break;
	case 'arrowup': e . preventDefault (); ws . bottom = null; ws . top = '8px'; break;
	default: break;
	}
	return true;
};

var OnWheel = function (e) {if (e . deltaY > 0) {if (scaling <= 0.16777216) return false; scaling /= 1.25; scaling = Number (scaling . toFixed (8));} else {scaling *= 1.25; scaling = Number (scaling . toFixed (8));} return false;};

var OnMouseDown = function (e) {
	e . preventDefault ();
	if (e . buttons === 2) simulated . SetTargetBearing (Math . atan2 (e . clientY - canvas . height * 0.5, e . clientX - canvas . width * 0.5));
	return false;
};

</script>

</body>
</html>
